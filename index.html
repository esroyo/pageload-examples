<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pageload examples</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./assets/new.css">
</head>
<body>
  <header>
    <h1>ğŸŒ&nbsp; Page loading</h1>
  </header>

  <details id="toc">
    <summary>Table of contents</summary>
    <ul>
      <li>Examples
        <ul>
          <li><a href="#basic-html">Loading a web site is a gradual process</a></li>
          <li><a href="#basic-html-style">External styles block rendering, but not DOM parsing</a></li>
          <li><a href="#basic-html-style-inline">Fast styled rendering, with inline styles</a></li>
          <li><a href="#basic-html-style-critical">Sweet spot: inline critical styles</a></li>
        </ul>
      </li>
      <li>Conclusions
      </li>
    <ul>
  </details>  

  <hr>

  <article id="basic-html">
    <h2>ğŸ“ Loading a web site is a gradual process</h2>

    <figure>
      <blockquote>
        It's important to understand that [...] is a gradual process. For better user experience, the rendering engine will try to display contents on the screen as soon as possible. It will not wait until all HTML is parsed before starting to build and layout the render tree. Parts of the content will be parsed and displayed, while the process continues with the rest of the contents that keeps coming from the network.
      </blockquote>
      <figcaption>
        &mdash; Tali Garsiel, <cite>How browsers work</cite>
      </figcaption>
    </figure>

    <p>Let's demonstrate that fact by loading a page with lots of text content. Page download is throttled by the server and takes a long time.</p>
    <p>Try to scroll down while the page is being downloaded.</p>
    <p>The display keeps updating, but <code>DOMContentLoaded</code> and <code>load</code> events won't trigger until the download and parsing of the HTML is <em>completed</em>.</p>
    <p>There is no <em>direct</em> correlation between the delay on those events and a poor core web vitals score. Although the page is loading, LCP will happen soon enough. This doesn't mean the "performance" of the page is good.</p>

    <p>
    <a href="https://proxy-throttle.deno.dev/?factor=5&url=https%3A%2F%2Fesroyo.github.io%2Fpageload-examples%2Fexamples%2Fbasic-html%2F" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fproxy-throttle.deno.dev%2F%3Ffactor%3D1%26url%3Dhttps%253A%252F%252Fesroyo.github.io%252Fpageload-examples%252Fexamples%252Fbasic-html%252F" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
     136.60 â”œ requestStart
     373.20 â”œ responseStart
            â”Š
    3213.90 â”œ paint: first-paint
    3213.90 â”œ paint: first-contentful-paint
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   30480.60 â”œ responseEnd
   30482.00 â”œ domInteractive
   30482.00 â”œ domContentLoadedEventStart
   30482.00 â”œ domContentLoadedEventEnd
   30482.40 â”œ domComplete
   30482.50 â”œ loadEventStart
   30482.50 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: It shows the first paint happening much earlier than the HTML's response end.
        </figcaption>
      </figure>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style">
    <h2>ğŸ“ External styles block rendering, but not DOM parsing</h2>
    <p>As we have seen in the previous example, the DOM content tree is gradually builded as the HTML is downloaded. What if we have an stylesheet link on that page?</p>
    <p>An external stylesheet by itself does not block <em>all</em> of the process. The fetching of the stylesheet starts, but the HTML parsing continues. The <code>DOMContentLoaded</code> event will trigger regardless the fetching of the style state.</p>

    <p><em>However</em>, although the <code>DOMContentLoaded</code> event fires, <strong>the page won't be displayed to the user</strong> until the fetching of the style is done.</p>

    <p>This means an stylesheet resource doesn't block the DOM parsing, but will block the rendering.</p>

    <p>
    <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-style/" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https://esroyo.github.io/pageload-examples/examples/basic-html-style/" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
     100.20 â”œ requestStart
     295.40 â”œ responseStart
     298.70 â”œ responseEnd
     326.40 â”œ domInteractive
     326.50 â”œ domContentLoadedEventStart
     326.50 â”œ domContentLoadedEventEnd
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   10745.40 â”œ domComplete
   10745.50 â”œ loadEventStart
   10745.50 â”œ loadEventEnd
   10841.60 â”œ paint: first-paint
   10841.60 â”” paint: first-contentful-paint</pre>
        <figcaption>
          Timeline: It shows that an external style link does not block the <code>DOMContentLoaded</code> event. However the first paint won't happen until the download and processing of the style resource ends. 
        </figcaption>
    </figure>

    </details>

    <details>
      <summary>Quirks</summary>
      <ul>
        <li><mark>Blink</mark>; When the <code>link</code> tag is located in the <code>head</code>, then as claimed the DOM parsing is not blocked. However if the <code>link</code> tag is located in the <code>body</code>, <strong>It blocks the DOM parsing</strong> (the hard way). Test it in <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-style-body/" target="_blank">this secondary example</a>. Gecko and WebKit based browsers don't observe this difference between <code>body</code> and <code>head</code>.</li>
      </ul>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style-inline">
    <h2>ğŸ“ Fast styled rendering, with inline styles</h2>

    <p>We can achieve the gradual rendering effect seen on the <a href="#basic-html">first example</a> while displaying already styled content. It is possible by inlining the contents of the stylesheet.</p>

    <p>Although inlining styles is a limited option (prevents caching, is difficult to scale),
    for the shake of the example It is cool to see how the browser can build the DOM and render styled contents as the HTML is dowloaded.</p>

    <p>
    <a href="https://proxy-throttle.deno.dev/?factor=5&url=https%3A%2F%2Fesroyo.github.io%2Fpageload-examples%2Fexamples%2Fbasic-html-style-inline%2F" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fproxy-throttle.deno.dev%2F%3Ffactor%3D1%26url%3Dhttps%253A%252F%252Fesroyo.github.io%252Fpageload-examples%252Fexamples%252Fbasic-html-style-inline%252F" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
      13.20 â”œ requestStart
     245.40 â”œ responseStart
            â”Š
    3264.70 â”œ paint: first-paint
    3264.70 â”œ paint: first-contentful-paint
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   35206.40 â”œ responseEnd
   35207.00 â”œ domInteractive
   35207.00 â”œ domContentLoadedEventStart
   35207.00 â”œ domContentLoadedEventEnd
   35207.20 â”œ domComplete
   35207.30 â”œ loadEventStart
   35207.30 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: It shows an early painting, given there are no external resources.
        </figcaption>
      </figure>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style-critical">
    <h2>ğŸ“ Sweet spot: inline critical styles</h2>

    <p>The best experience comes when only <a href="https://css-tricks.com/authoring-critical-fold-css/" target="_blank">critical styles</a> are inlined, as we get the gradual rendering effect of styled content.</p>

    <p>However It forces the loading of the non-critical styles on a deferred stage. The <code>media</code> attribute <a href="https://github.com/filamentgroup/loadCSS" target="_blank">trick</a> is a well known option for the deferred load. Although It feels hackish and relies on JavaScript.</p>

    <p>Another possiblity would be to put the non-critical styles in a <code>link rel="preload"</code> tag. Thus neither DOM parsing nor rendering should be blocked. Finally place the regular <code>link</code> to the same style at the very end of the <code>body</code>, where it <em>could</em> block the rendering but not the DOM. At that point the user should be already seeing content (styled with the critical CSS).</p>

    <p>This sweet spot solution is ruined by one actor. As commented in the quirks of the <a href="#basic-html-style">external styles example</a>, Blink blocks the DOM parsing when it finds a style <code>link</code> in the <code>body</code>. Although user exeperience is good, the delay of <code>DOMContentLoaded</code> on Blink makes this solution non-generalizable.</p>

    <a href="https://proxy-throttle.deno.dev/?factor=2&url=https%3A%2F%2Fesroyo.github.io%2Fpageload-examples%2Fexamples%2Fbasic-html-style-critical%2F" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fproxy-throttle.deno.dev%2F%3Ffactor%3D1%26url%3Dhttps%253A%252F%252Fesroyo.github.io%252Fpageload-examples%252Fexamples%252Fbasic-html-style-critical%252F" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
      77.00 â”œ requestStart
            â”Š
            â”Š
    3262.00 â”œ responseStart
    3323.00 â”œ paint: first-contentful-paint
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   12167.00 â”œ responseEnd
   12169.00 â”œ domInteractive
   12169.00 â”œ domContentLoadedEventStart
   12169.00 â”œ domContentLoadedEventEnd
            â”Š
            â”Š
            â”Š
            â”Š
   18751.00 â”œ domComplete
   18751.00 â”œ loadEventStart
   18751.00 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: It shows an early paint. Contents are displayed as they arrive, styled with the critical inlined styles. Meanwhile non-critical styles are being downloaded and won't block <code>DOMContentLoaded</code>. Once the non-critical styles are downloaded, <code>load</code> triggers and the styles are applied (reflow). This sequence of events is taken from a WebKit based browser.
        </figcaption>
    </figure>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

</body>
</html>

