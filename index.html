<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pageload examples</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Learn how a web page loads by example">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
  <link rel="stylesheet" href="./assets/new.css">
</head>
<body>
  <header>
    <h1>ğŸŒ&nbsp; Page loading</h1>
  </header>

  <details id="toc" open>
    <summary>Table of contents</summary>
    <ul>
      <li><a href="#basic-html">Loading a web site is a gradual process</a></li>
      <li><a href="#basic-html-style">External styles block rendering, but not the HTML parsing</a></li>
      <li><a href="#basic-html-style-inline">Fast styled rendering, with inline styles</a></li>
      <li><a href="#basic-html-style-critical">Sweet spot: inline critical styles</a></li>
      <li><a href="#basic-html-script">Scripts block document parsing, but not rendering</a></li>
      <li><a href="#basic-html-style-script">Scripts execution requires to finish any ongoing styles loading</a></li>
      <li><a href="#basic-html-style-script-defer">Deferred scripts don't block parsing</a></li>
    </ul>
  </details>  

  <hr>

  <article id="basic-html">
    <h2>ğŸ“ Loading a web site is a gradual process</h2>

    <figure>
      <blockquote>
        It's important to understand that [...] is a gradual process. For better user experience, the rendering engine will try to display contents on the screen as soon as possible. It will not wait until all HTML is parsed before starting to build and layout the render tree. Parts of the content will be parsed and displayed, while the process continues with the rest of the contents that keeps coming from the network.
      </blockquote>
      <figcaption>
        &mdash; Tali Garsiel, <cite>How browsers work</cite>
      </figcaption>
    </figure>

    <p>Let's demonstrate that fact by loading a page with lots of text content. Page download is throttled by the server and takes a long time.</p>
    <p>Try to scroll down while the page is being downloaded.</p>
    <p>The display keeps updating, but <code>DOMContentLoaded</code> event won't trigger until the download and parsing of the HTML is <em>completed</em>.</p>
    <p>There is no <em>direct</em> correlation between the delay on those events and a poor core web vitals score. Although the page is loading, LCP will happen soon enough. This doesn't mean the "performance" of the page is good.</p>

    <p>
    <a href="https://proxy-throttle.deno.dev/?factor=5&url=https%3A%2F%2Fesroyo.github.io%2Fpageload-examples%2Fexamples%2Fbasic-html%2F" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fproxy-throttle.deno.dev%2F%3Ffactor%3D1%26url%3Dhttps%253A%252F%252Fesroyo.github.io%252Fpageload-examples%252Fexamples%252Fbasic-html%252F" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
     136.60 â”œ requestStart
     373.20 â”œ responseStart
            â”Š
    3213.90 â”œ paint: first-paint
    3213.90 â”œ paint: first-contentful-paint
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   30480.60 â”œ responseEnd
   30482.00 â”œ domInteractive
   30482.00 â”œ domContentLoadedEventStart
   30482.00 â”œ domContentLoadedEventEnd
   30482.40 â”œ domComplete
   30482.50 â”œ loadEventStart
   30482.50 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: It shows the first paint happening much earlier than the HTML's response end.
        </figcaption>
      </figure>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style">
    <h2>ğŸ“ External styles block rendering, but not HTML parsing</h2>
    <p>As we have seen in the previous example, the DOM content tree is gradually builded as the HTML is downloaded. What if we have an stylesheet link on that page?</p>
    <p>An external stylesheet by itself does not block <em>all</em> of the process. The fetching of the stylesheet starts, but the HTML parsing continues. The <code>DOMContentLoaded</code> event will trigger regardless the fetching of the style state.</p>

    <p><em>However</em>, although the <code>DOMContentLoaded</code> event fires, <strong>the page won't be displayed to the user</strong> until the fetching of the style is done.</p>

    <p>This means an stylesheet resource doesn't block the document parsing, but will block the rendering.</p>

    <p>
    <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-style/" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https://esroyo.github.io/pageload-examples/examples/basic-html-style/" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
      83.90 â”œ requestStart
     272.10 â”œ responseStart
     274.30 â”œ responseEnd
     280.10 â”œ resourceStart: link("â€¦mples/assets/new.css")
     287.80 â”œ domInteractive
     287.80 â”œ domContentLoadedEventStart
     287.80 â”œ domContentLoadedEventEnd
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   10559.70 â”œ resourceEnd: link("â€¦mples/assets/new.css")
   10692.60 â”œ domComplete
   10692.60 â”œ loadEventStart
   10692.60 â”œ loadEventEnd
   10833.80 â”œ paint: first-paint
   10833.80 â”” paint: first-contentful-paint</pre>
        <figcaption>
          Timeline: It shows that an external style link does not block the <code>DOMContentLoaded</code> event. However the first paint won't happen until the download and processing of the style resource ends. 
        </figcaption>
    </figure>

    </details>

    <details>
      <summary>Quirks</summary>
      <ul>
        <li><mark>Blink</mark>; When the <code>link</code> tag is located in the <code>head</code>, then as claimed the document parsing is not blocked. However if the <code>link</code> tag is located in the <code>body</code>, <strong>It blocks the document parsing</strong> (the hard way). Test it in <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-style-body/" target="_blank">this secondary example</a>. Gecko and WebKit based browsers don't observe this difference between <code>body</code> and <code>head</code>.</li>
      </ul>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style-inline">
    <h2>ğŸ“ Fast styled rendering, with inline styles</h2>

    <p>We can achieve the gradual rendering effect seen on the <a href="#basic-html">first example</a> while displaying already styled content. It is possible by inlining the contents of the stylesheet.</p>

    <p>Although inlining styles is a limited option (prevents caching, is difficult to scale),
    for the shake of the example It is cool to see how the browser can build the DOM and render styled contents as the HTML is dowloaded.</p>

    <p>
    <a href="https://proxy-throttle.deno.dev/?factor=5&url=https%3A%2F%2Fesroyo.github.io%2Fpageload-examples%2Fexamples%2Fbasic-html-style-inline%2F" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fproxy-throttle.deno.dev%2F%3Ffactor%3D1%26url%3Dhttps%253A%252F%252Fesroyo.github.io%252Fpageload-examples%252Fexamples%252Fbasic-html-style-inline%252F" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
      13.20 â”œ requestStart
     245.40 â”œ responseStart
            â”Š
    3264.70 â”œ paint: first-paint
    3264.70 â”œ paint: first-contentful-paint
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   35206.40 â”œ responseEnd
   35207.00 â”œ domInteractive
   35207.00 â”œ domContentLoadedEventStart
   35207.00 â”œ domContentLoadedEventEnd
   35207.20 â”œ domComplete
   35207.30 â”œ loadEventStart
   35207.30 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: It shows an early painting, given there are no external resources.
        </figcaption>
      </figure>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style-critical">
    <h2>ğŸ“ Sweet spot: inline critical styles</h2>

    <p>The best experience comes when only <a href="https://css-tricks.com/authoring-critical-fold-css/" target="_blank">critical styles</a> are inlined, as we get the gradual rendering effect of styled content.</p>

    <p>However It forces the loading of the non-critical styles on a deferred stage. The <code>media</code> attribute <a href="https://github.com/filamentgroup/loadCSS" target="_blank">trick</a> is a well known option for the deferred load. Although It feels hackish and relies on JavaScript.</p>

    <p>Another possiblity would be to put the non-critical styles in a <code>link rel="preload"</code> tag. That <code>link</code> wouldn't block document parsing nor rendering. Finally place the regular <code>link</code> to the same style at the very end of the <code>body</code>. Rendering can't be blocked if something has been already painted.</p>

    <p>This would be a sweet spot solution, except for the quirk commented on the <a href="#basic-html-style">external styles example</a>. Blink blocks the document parsing when it finds a style <code>link</code> in the <code>body</code>. Thus although the visual exeperience is good, the delay of <code>DOMContentLoaded</code> makes this solution non-generalizable.</p>

    <p><a href="https://proxy-throttle.deno.dev/?factor=2&url=https%3A%2F%2Fesroyo.github.io%2Fpageload-examples%2Fexamples%2Fbasic-html-style-critical-blink%2F" target="_blank">This secondary example</a> shows the alternative for Blink (using the <code>onload</code> attribute).</p>

    <p>
    <a href="https://proxy-throttle.deno.dev/?factor=2&url=https%3A%2F%2Fesroyo.github.io%2Fpageload-examples%2Fexamples%2Fbasic-html-style-critical%2F" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fproxy-throttle.deno.dev%2F%3Ffactor%3D1%26url%3Dhttps%253A%252F%252Fesroyo.github.io%252Fpageload-examples%252Fexamples%252Fbasic-html-style-critical%252F" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
      84.00 â”œ requestStart
            â”Š
            â”Š
    3226.00 â”œ responseStart
    3275.00 â”œ resourceStart: link("â€¦mples/assets/new.css")
    3313.00 â”œ paint: first-contentful-paint
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   12443.00 â”œ responseEnd
   12445.00 â”œ domInteractive
   12445.00 â”œ domContentLoadedEventStart
   12445.00 â”œ domContentLoadedEventEnd
            â”Š
            â”Š
            â”Š
            â”Š
   18586.00 â”œ resourceEnd: link("â€¦mples/assets/new.css")
   18779.00 â”œ domComplete
   18779.00 â”œ loadEventStart
   18779.00 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: It shows an early paint. Contents are displayed as they arrive, styled with the critical inlined styles. Meanwhile non-critical styles are being preloaded and won't block anything. Once the non-critical styles are downloaded the styles are applied (reflow). This sequence of events is taken from a WebKit based browser.
        </figcaption>
    </figure>
    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-script">
    <h2>ğŸ“ Scripts block document parsing, but not rendering</h2>
    <p>When an script is found in the HTML, the browser pauses the document parsing until the script is executed.</p>

    <p>If the script is external, It must be fetched and then executed. Document parsing won't continue until the script ends execution.</p>

    <p>Givent that an script does not necessarily block the rendering, the location of the script in the document is important. If the script is located at the end of the body, some rendering is possible</p>.

    <p>
    <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-script/" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https://esroyo.github.io/pageload-examples/examples/basic-html-script/" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
      12.90 â”œ requestStart
      14.20 â”œ responseStart
      16.50 â”œ responseEnd
      20.20 â”œ resourceStart: script("â€¦mples/assets/junk.js")
      62.10 â”œ paint: first-paint
      62.10 â”œ paint: first-contentful-paint
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   10395.70 â”œ resourceEnd: script("â€¦mples/assets/junk.js")
   10397.10 â”œ mark: script execution
   10402.50 â”œ domInteractive
   10402.60 â”œ domContentLoadedEventStart
   10402.60 â”œ domContentLoadedEventEnd
   10420.10 â”œ domComplete
   10420.20 â”œ loadEventStart
   10420.20 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: It shows that an external script blocks document parsing. <code>DOMContentLoaded</code> event won't fire until the script is fetched and executed. However if enough document content has been already parsed, paint still happens. 
        </figcaption>
    </figure>

    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style-script">
    <h2>ğŸ“ Scripts execution requires to finish the ongoing styles loading</h2>

    <p>As we have seen <a href="#basic-html-style">previously</a>, and external stylesheet will not block the document parsing. However if the external style is followed by an script, things change.</p>
   
    <p>An script not only pauses the document parsing, but also requires to finish the <em>ongoing</em> styles loading. Only then will start its execution.</p>

    <p>So document parsing becomes blocked when it gets to an script. In turn the script execution is blocked by the loading styles.</p>

    <p>Note we emphasize the fact that only <em>ongoing</em> loading styles will block the script. If the order is inverted and the script is placed before the style, It will get executed immediately. See that in <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-script-style/" target="_blank">this secondary example</a> (timeline will be similar to the <a href="#basic-html-style">second case</a>).</p>

    <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-style-script/" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https://esroyo.github.io/pageload-examples/examples/basic-html-style-script/" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre>
       0.00 â”¬ startTime
      13.50 â”œ requestStart
      14.50 â”œ responseStart
      17.10 â”œ responseEnd
      21.50 â”œ resourceStart: link("â€¦mples/assets/new.css")
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
            â”Š
   10664.50 â”œ resourceEnd: link("â€¦mples/assets/new.css")
   10790.70 â”œ mark: script execution
   10826.20 â”œ domInteractive
   10826.20 â”œ domContentLoadedEventStart
   10826.20 â”œ domContentLoadedEventEnd
   10842.20 â”œ paint: first-paint
   10842.20 â”œ paint: first-contentful-paint
   11041.90 â”œ domComplete
   11041.90 â”œ loadEventStart
   11042.00 â”” loadEventEnd</pre>
        <figcaption>
          Timeline: The external style by itself would not block the document parsing, as seen <a href="#basic-html-style">previously</a>. However the script gets blocked by the style loading, and in turn the script blocks the document parsing. Thus DOM interactive is bounded by the style loading plus the script execution.
        </figcaption>
    </figure>

    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>

  <hr>

  <article id="basic-html-style-script-defer">
    <h2>ğŸ“ Deferred scripts don't block parsing</h2>

    <p>Even though deferred scripts don't block document parsing and get downloaded in parallel (with low priority), they share some key behaviours with the "normal" synchronous script tags:
      <ul>
        <li>They are executed in the order they were found in the document.</li>
        <li>They must wait for ongoing styles loading (if any) to end.</li>
        <li>They are executed before <code>DOMContentLoaded</code> event.</li>
        <li>They don't block rendering. (see <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-script-defer/" target="_blank">secondary example</a>)</li>
      </ul>
    </p>

    <p>They are all executed at the same time, before <code>DOMContentLoaded</code>. Therefore all deferred scripts need to be completely downloaded before any of them can execute.</p>

    <a href="https://esroyo.github.io/pageload-examples/examples/basic-html-style-script-defer/" target="_blank"><button>Open example</button></a>
    <a href="https://pagespeed.web.dev/analysis?url=https://esroyo.github.io/pageload-examples/examples/basic-html-style-script-defer/" target="_blank"><button>Test on PageSpeed</button></a>
    </p>

    <details>
      <summary>Timeline</summary>
      <figure>
        <pre></pre>
        <figcaption>
          Timeline: The external style by itself would not block the document parsing, as seen <a href="#basic-html-style">previously</a>. However the script gets blocked by the style loading, and in turn the script blocks the document parsing. Thus DOM interactive is bounded by the style loading plus the script execution.
        </figcaption>
    </figure>

    </details>

    <p>[<a href="#toc">TOP</a>]</p>
  </article>


</body>
</html>

